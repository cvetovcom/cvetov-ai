# Changelog - AI Shopping Assistant

## [2024-12-09] Поддержка фильтрации по цвету цветов

### Добавлено
- **Гибкая система фильтрации по цвету цветов** с использованием Claude API
- Интерфейс `FlowerPreference` с опциональным полем `color`
- Helper функции для парсинга и нормализации цветов и названий цветов
- Поддержка 13 известных цветов: белая, красная, розовая, персиковая, желтая, оранжевая, голубая, сиреневая, бордовая, пурпурная, бежевая, кремовая, лиловая

### Изменено
- **`parsePreferences()`** (functions/src/index.ts:651-754):
  - Теперь возвращает `FlowerPreference[]` вместо `string[]`
  - Обновлен промпт Claude для извлечения цветов
  - Добавлена валидация с обратной совместимостью

- **`matchesPreferences()`** (functions/src/index.ts:788-865):
  - Полностью переписана логика фильтрации
  - Реализованы 2 правила:
    - **ПРАВИЛО 1 (disliked - жесткое)**:
      - Если цвет НЕ указан → исключить весь цветок
      - Если цвет указан → исключить только этот цвет
    - **ПРАВИЛО 2 (liked - гибкое)**:
      - Если цвет НЕ указан → показать любой цвет
      - Если цвет указан → показать только этот цвет

### Примеры работы

#### Пример 1: "розы" (без цвета)
```
Вход: "розы"
Claude API: {liked: [{flower: "роза"}]}
Результат: Показываются розы ЛЮБОГО цвета (белые, красные, розовые и т.д.)
```

#### Пример 2: "белые розы"
```
Вход: "белые розы"
Claude API: {liked: [{flower: "роза", color: "белая"}]}
Результат: Показываются ТОЛЬКО белые розы
```

#### Пример 3: "красные и белые розы"
```
Вход: "красные и белые розы"
Claude API: {liked: [{flower: "роза", color: "красная"}, {flower: "роза", color: "белая"}]}
Результат: Показываются красные ИЛИ белые розы
```

#### Пример 4: "розы, но без гвоздик"
```
Вход: "розы, но без гвоздик"
Claude API: {liked: [{flower: "роза"}], disliked: [{flower: "гвоздика"}]}
Результат: Показываются розы любого цвета, исключаются все гвоздики
```

#### Пример 5: "без красных гвоздик, белые розы"
```
Вход: "без красных гвоздик, белые розы"
Claude API: {liked: [{flower: "роза", color: "белая"}], disliked: [{flower: "гвоздика", color: "красная"}]}
Результат: Показываются белые розы, исключаются только красные гвоздики (белые гвоздики OK)
```

### Технические детали

#### Новые функции
- `extractFlowerName(text: string)` - извлекает название цветка из "роза белая"
- `extractFlowerColor(text: string)` - извлекает цвет из "роза белая"
- `normalizeFlower(word: string)` - нормализует окончания цветов (розы → роз)
- `normalizeColor(word: string)` - нормализует окончания цветов (белая → бел)

#### Интерфейсы
```typescript
interface FlowerPreference {
  flower: string     // "роза", "тюльпан"
  color?: string     // "белая", "красная" (опционально!)
}
```

#### API Claude
- Модель: `claude-3-5-haiku-20241022`
- Max tokens: 200
- Few-shot промпт с 6 примерами
- Graceful fallback при ошибках

### Обратная совместимость
- Сохранена поддержка старого формата `string[]` через функцию валидации
- Если Claude вернет старый формат `["розы"]`, система автоматически преобразует его в `[{flower: "розы"}]`

---

## [Предыдущие версии]
См. git history для более ранних изменений.
